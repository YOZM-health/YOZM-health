<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.yozmhealth.board.mapper.BoardMapper">
    <!--게시글 목록(페이징 + 검색) +공지 게시글 추가-->
    <select id="findAll" resultType="com.example.yozmhealth.board.vo.dto.BoardDto$BoardResponse">
        select
            b.BOARD_NO,
            b.BOARD_TITLE,
            b.BOARD_CONTENT,
            b.BOARD_AUTHOR,
            b.READ_COUNT,
            b.BOARD_CODE,
            b.BOARD_STATUS,
            b.CREATE_DATE
        from
            board b
        where
            b.BOARD_DEL_FL = 'N' and b.BOARD_STATUS = 'C'
        order by b.BOARD_NO desc
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <!-- 게시글 검색 -->
            <if test="searchType=='T'.toString() and keyword != null and keyword != '' ">
                AND board_title like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType=='C'.toString() and keyword != null and keyword != '' ">
                AND board_content like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType=='A'.toString() and keyword != null and keyword != '' ">
                AND board_author like CONCAT('%', #{keyword}, '%')
            </if>
        </trim>
        <!--페이징-->
        LIMIT #{perPageNum}	 OFFSET #{pageStart}
    </select>

    <!--게시글 조회-->
    <select id="findByBoardId" parameterType="Long" resultType="com.example.yozmhealth.board.vo.dto.BoardDto$BoardResponse">
        select
            b.board_no,
            b.board_title,
            b.board_content,
            b.read_count,
            b.create_date
        from
            board b
        where
            b.BOARD_NO = #{id} and b.board_del_fl = 'N' and b.BOARD_STATUS = 'P'
    </select>

    <!--게시글 조회수-->
    <select id="boardTotalCount" resultType="Long">
        select count(*) from board b
    </select>

    <!--자유 게시글 작성-->
    <insert id="insertBoard" parameterType="com.example.yozmhealth.board.vo.dto.BoardDto$BoardRequest" useGeneratedKeys="true" keyProperty="boardNo">
        insert into board(board_title,board_content,board_author,board_del_fl,board_code,read_count,create_date)
        values (#{boardTitle},#{boardContent},#{boardAuthor},'N',1,0,now())
    </insert>

    <!--게시글 수정-->
    <update id="updateBoard">
        update
            board b
        set
            b.BOARD_CONTENT = #{boardContent},
            b.BOARD_TITLE = #{boardTitle}
        where
            b.BOARD_DEL_FL = 'N' and b.BOARD_NO = #{boardNo}
    </update>

    <!--게시글 삭제(논리삭제)-->
    <update id="deleteBoard" parameterType="Long">
        update
            board b
        set
            b.BOARD_DEL_FL = 'Y'
        where
            b.BOARD_NO = #{boardNo}
    </update>

    <!--게시글 조회수 증가-->
    <update id="readCountUp" parameterType="Long">
        update
            board b
        set
            b.READ_COUNT = b.BOARD_NO + 1
        where
            b.BOARD_NO = #{boardNo} and b.BOARD_DEL_FL = 'N';
    </update>

    <!--게시글 이전/다음글-->
    <select id="boardNextPrevious" parameterType="Long" resultType="com.example.yozmhealth.board.vo.dto.BoardDto$BoardResponse">
        <![CDATA[
        select
            b.BOARD_NO as boardNo,
            b.board_title as boardTitle
        from
            board b
        where
            BOARD_NO in(
                (select b.BOARD_NO from board where b.BOARD_NO < #{boardNo}
                order by BOARD_NO desc limit 1),
                (select b.BOARD_NO from board where b.BOARD_NO > #{boardNo}
                order by BOARD_NO limit 1)
            )
        order by BOARD_NO desc;
        ]]>
    </select>
</mapper>